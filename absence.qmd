---
title: "Let's Talk About Absence"
author: "Professor Adam Dennett FRGS FAcSS, Professor of Urban Analytics, Bartlett Centre for Advanced Spatial Analysis, University College London - a.dennett@ucl.ac.uk - @adam_dennett"
published-title: 12/12/24
format: html
editor: visual
bibliography: references.bib
---

```{r echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, include=FALSE, results='hide'}
library(tidyr)
library(dplyr)
library(writexl)
library(tidyverse)
library(here)
library(janitor)
library(sf)
library(usethis)
library(tmap)
library(readxl)
library(r5r)
library(RColorBrewer)
library(accessibility)
library(data.table)
library(ggplot2)
library(interp)
library(h3jsr)
library(h3r)
library(osmextract)
library(stplanr)
library(od)
library(tidytransit)

```

## Absence/Attendance and Attainment?

In this piece I am going to change the focus of the conversation and look at something which has thus far been absent (excuse the pun) from any of the conversations about the school system in Brighton. The issue of absence/attendance and its importance for educational outcomes.

### Improving Educational Outcomes

The Council's premise in the very first slide shown in the engagement exercise back in October, was that Brighton and Hove has a large attainment gap and is failing its most disadvantaged pupils. Now, I have since refuted that claim here - <https://adamdennett.github.io/BH_Schools_2/stain_removal.html> - and shown that Brighton is not performing badly as a city and indeed is above the national median.

However, attainment and disadvantage is still an important topic for the council and is one of the main drivers behind the new consultation, so let's stick with it for the moment. The new proposals in the consultation zoom in on disadvantage as one of the motivating factors, citing in 3.7 ([supporting documents here](https://democracy.brighton-hove.gov.uk/mgAi.aspx?ID=102291)) that they want a system that "delivers childrens' outcomes which are good and improving especially for those at risk of disadvantage" and under 3.9 that, "the proposals put forward were designed to include: a) Better equality of outcomes – results not driven by economic advantage. b) Deliver a ‘comprehensive’ offer from our city schools as a more mixed pupil intake creates better outcomes for disadvantaged pupils."

We can distil those statements into the following goals:

1.  **Improving Outcomes for Disadvantaged Children**: The council aims to create a system that enhances and improves outcomes, particularly for children at risk of disadvantage.

2.  **Equality of Outcomes**: The proposals emphasize achieving better equality in educational results, ensuring that outcomes are not influenced by economic advantage.

The assumption revealed in the last statement above, is the belief that the main route to achieving these goals is through creating a more mixed intake in schools. We know this is influenced quite heavily by some of the work of Stephen Gorard (<https://theconversation.com/poorer-pupils-do-worse-at-school-heres-how-to-reduce-the-attainment-gap-205535>), but where even Gorard concedes some of practical limitations of forced mixing ("Pupils could be given free transport to schools outside their immediate neighbourhood"), there might be even bigger issues. How do we know that a lack of mixing is indeed the main factor holding back disadvantaged attainment? What if it is not? And if it is not, what is more important? And if there are more important factors, might there be more effective routes to minimising disadvantged educational outcomes that could offer better or faster results, and indeed do so without the levels of disruption currently on the table?

These are very important questions to ask, not least because under the current proposals, one of the experimental treatments being prescribed by the council is forced mixing in schools through '[busing](https://en.wikipedia.org/wiki/Desegregation_busing)' significant numbers of students from some neighbouroods to schools a long way from their homes. This kind of forced mixing not only has a questionable history and efficacy in other contexts (see [@rossell1990] and others for the US history - a very different context, but same underlying idea), but has huge financial, environmental and social implications (many of which were [raised in the Parent Support Group's latest deputation at the Labour Cabinet meeting in November](https://www.parentsupport.group/deputation-to-brighton-council-cabinet-5th-dec-2024/)) which have thus far been ignored by those pushing forward the proposals and which could do huge damage to the city.

### Is there anything more important than social mixing holding back educational attainment, particularly for disadvantaged pupils?

The short answer is: Yes, yes there is. The longer answer is there are lots of things; from income deprivation, requiring SEN support to simply moving schools (see p8 of [@claymore2023] to see the relative effects of some of these) which can impact attainment. But there is one factor, over an above everything else, that affects attainment the most: **Absence from School.**

## Absence

Now at this point, you'd be forgiven for shouting "***well that's bloody obvious, I could have told you that!***" - which makes it all the more surprising that it has barely surfaced in the narrative during this whole Brighton Secondary School Admissions engagement/consultation process.

I genuinely don't know why it hasn't, but again the rush to consultation and the lack of due care and attention and gathering of relevant evidence throughout are probably in the blame line-up.

### The Evidence - the literature

I could get all academic and cite a bunch of papers and government reports, at this juncture, which detail the important role that absence/attendance plays in educational outcomes. Alright, I could and I will. For example, in a [report for the Government's Social Mobility Commission](https://www.gov.uk/government/publications/against-the-odds/against-the-odds-achieving-greater-progress-for-secondary-students-facing-socio-economic-disadvantage), [@riordan2021] state:

"Our statistical models indicate that the strongest predictive factor of the progress made by pupil premium \[disadvantaged\] students is the school’s absence rate"

"schools with lower absence rates have smaller progress gaps; pupil premium students progress more at schools with lower absence rates; This correlation is regardless of whether they begin with low, medium or high rates of absence."

"These findings concur with previous research and we share their interpretation too, that this correlation is most likely to be causal. This is because there is an intuitive underlying causal mechanism: students not in school are less likely to learn the school curriculum."

[@claymore2023a] (already citied above) in a paper titled: "[Being Present: the Power of Attendance and Stability for Stability for Disadvantaged Pupils](https://www.nfer.ac.uk/publications/being-present-the-power-of-attendance-and-stability-for-disadvantaged-pupils/)" states:

"On average, the association between being absent from school and KS4 outcomes is worse for disadvantaged pupils than their more affluent peers"

"Supporting secondary schools to reduce absence, improve behaviour and support within-secondary phase transfers are all key areas of policy focus to boost outcomes of disadvantaged pupils and reduce group gaps in progress and attainment."

"over half of the gap in outcomes between disadvantaged pupils and their more affluent peers is associated with the underlying group differences in absence, exclusion and pupil transfer rates. Improving these underlying factors for disadvantaged pupils should therefore substantially boost outcomes for the group"

I could also go on to cite work by the National Governance Association [@nga2024] on improving School Attendance, or the Department for Education's extensive resources on why improving school attendance is important[@dfe2023] [@dfe2024].

So the literature clearly says absence is important but:

-   Is it important for Brighton and Hove?

-   Is it more or less important than social mixing or concentrations of disadvantage in the city?

Fortunately, as has been the case throughout this whole engagement/consultation exercise, data and analysis can shed some light and help us answer these questions

```{r}
#References

#https://educationhub.blog.gov.uk/2023/05/18/school-attendance-important-risks-missing-day/

#https://www.nga.org.uk/knowledge-centre/improving-school-attendance/

#https://www.nga.org.uk/knowledge-centre/disadvantage-in-education/
#
#https://www.nfer.ac.uk/publications/being-present-the-power-of-attendance-and-stability-for-disadvantaged-pupils/ 
  
#https://www.gov.uk/government/publications/against-the-odds

##this one has the gold
#https://www.gov.uk/government/publications/against-the-odds/against-the-odds-achieving-greater-progress-for-secondary-students-facing-socio-economic-disadvantage
# 
# "Our statistical models indicate that the strongest predictive factor of the progress made by pupil premium students is the school’s absence rate:[footnote 31]"
# 
# "schools with lower absence rates have smaller progress gaps
# pupil premium students progress more at schools with lower absence rates
# This correlation is regardless of whether they begin with low, medium or high rates of absence."
# 
# "These findings concur with previous research and we share their interpretation too, that this correlation is most likely to be causal. This is because there is an intuitive underlying causal mechanism: students not in school are less likely to learn the school curriculum.[footnote 32]"

#https://assets.publishing.service.gov.uk/media/66bf300da44f1c4c23e5bd1b/Working_together_to_improve_school_attendance_-_August_2024.pdf 


```

### The Evidence - the data

```{r echo=FALSE, message=FALSE, warning=FALSE}
#unauthorised absence

#https://explore-education-statistics.service.gov.uk/data-catalogue/data-set/be024b4d-4f91-40e4-8a58-50dc53dcc93f

##school performance
#https://www.compare-school-performance.service.gov.uk/


#from here - https://explore-education-statistics.service.gov.uk/data-catalogue/data-set/be024b4d-4f91-40e4-8a58-50dc53dcc93f
absence <- read_csv("https://explore-education-statistics.service.gov.uk/data-catalogue/data-set/be024b4d-4f91-40e4-8a58-50dc53dcc93f/csv")

absence_meta <- as.data.frame(names(absence))

absence <- absence %>% 
  mutate(year = as.numeric(substr(time_period, 1, 4)))


# Filter the dataframe
absence_2022 <- absence %>%
  filter(year == "2022" & !is.na(la_name) & education_phase == "State-funded secondary")

brighton_rate_2022 <- absence_2022 %>%
  filter(la_name == "Brighton and Hove") %>%
  pull(sess_unauthorised_percent)

library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(dplyr)

# Ensure the data has necessary columns and correct types
absence <- absence %>%
  mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor



# Ensure the data has necessary columns and correct types
absence_secondary <- absence %>%
  filter(education_phase == "State-funded secondary") %>%
  mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor

btn_absence_secondary <- absence_secondary %>%
  filter(la_name == "Brighton and Hove")

eng_absence_secondary <- absence_secondary %>%
  filter(geographic_level == "National")

medians <- absence_secondary %>%
  group_by(year) %>%
  summarize(median_sess_unauthorised_percent = median(sess_unauthorised_percent, na.rm = TRUE))


ggplot(absence_secondary, aes(x = sess_unauthorised_percent, fill = factor(year))) +
  geom_histogram(binwidth = 0.2, color = "black", alpha = 0.4, position = "identity") +
  geom_vline(data = medians, aes(xintercept = median_sess_unauthorised_percent, color = "England Median"), linetype = "solid", size = 1) +
  geom_vline(data = btn_absence_secondary, aes(xintercept = sess_unauthorised_percent, color = "Brighton and Hove"), linetype = "dashed", linewidth = 1) +
  facet_wrap(~ year) +  # Facet by year
  labs(title = "Unauthorised Absence Rates (% sessions missed) \nfor State-funded Secondary Schools by Year",
       x = "Unauthorised Absence Rate",
       y = "Count",
       fill = "Year",
       color = "") +  # Change legend title
  theme_minimal() +
  scale_fill_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for fill colors
  scale_color_manual(values = c("England Median" = "black", "Brighton and Hove" = "blue")) +  # Correct manual scale
  guides(color = guide_legend(override.aes = list(linetype = c("dashed", "solid"), 
                                                   shape = c(NA, NA), 
                                                   size = c(1, 1))))



```

```{r echo=FALSE, message=FALSE, warning=FALSE}

medians <- absence_secondary %>%
  group_by(year) %>%
  summarize(median_sess_overall_percent = median(sess_overall_percent, na.rm = TRUE))

ggplot(absence_secondary, aes(x = sess_overall_percent, fill = factor(year))) +
  geom_histogram(binwidth = 0.2, color = "black", alpha = 0.4, position = "identity") +
  geom_vline(data = medians, aes(xintercept = median_sess_overall_percent, color = "England Median"), linetype = "solid", size = 1) +
  geom_vline(data = btn_absence_secondary, aes(xintercept = sess_overall_percent, color = "Brighton and Hove"), linetype = "dashed", linewidth = 1) +
  facet_wrap(~ year) +  # Facet by year
  labs(title = "Overall Absence Rates (% sessions missed) \nfor State-funded Secondary Schools by Year",
       x = "Overall Absence Rate",
       y = "Count",
       fill = "Year",
       color = "") +  # Change legend title
  theme_minimal() +
  scale_fill_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for fill colors
  scale_color_manual(values = c("England Median" = "black", "Brighton and Hove" = "blue")) +  # Correct manual scale
  guides(color = guide_legend(override.aes = list(linetype = c("dashed", "solid"), 
                                                   shape = c(NA, NA), 
                                                   size = c(1, 1))))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
medians <- absence_secondary %>%
  group_by(year) %>%
  summarize(median_enrolments_pa_10_exact_percent = median(enrolments_pa_10_exact_percent, na.rm = TRUE))

ggplot(absence_secondary, aes(x = enrolments_pa_10_exact_percent, fill = factor(year))) +
  geom_histogram(binwidth = 0.5, alpha = 1, position = "identity") +
  geom_vline(data = medians, aes(xintercept = median_enrolments_pa_10_exact_percent, color = "England Median"), linetype = "solid", size = 1) +
  geom_vline(data = btn_absence_secondary, aes(xintercept = enrolments_pa_10_exact_percent, color = "Brighton and Hove"), linetype = "dashed", linewidth = 1) +
  facet_wrap(~ year) +  # Facet by year
  labs(title = "Persistent Absence Rates (% sessions missed) \nfor State-funded Secondary Schools by Year",
       x = "Persistent Absence Rate",
       y = "Count",
       fill = "Year",
       color = "") +  # Change legend title
  theme_minimal() +
  scale_fill_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for fill colors
  scale_color_manual(values = c("England Median" = "black", "Brighton and Hove" = "blue")) +  # Correct manual scale
  guides(color = guide_legend(override.aes = list(linetype = c("dashed", "solid"), 
                                                   shape = c(NA, NA), 
                                                   size = c(1, 1))))
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
# Histogram with vertical lines and labels

# Line plot for sess_unauth_totalreasons_rate for Brighton and Hove over all values of year 

absence_btn <- absence %>%
  filter(la_name == "Brighton and Hove" & education_phase == "State-funded secondary") %>%
  mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor

ggplot(absence_btn, aes(x = year, y = sess_unauthorised_percent, group = 1)) + 
  geom_line(color = "black") +
  geom_point() +
  labs(title = "Unauthorised Absence Rates Over Time for Brighton and Hove", 
       x = "Year", 
       y = "Unauthorised Absence Rate") + 
  theme_minimal()


```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Line plot for sess_unauth_totalreasons_rate for Brighton and Hove over all values of year 
absence_btn <- absence %>%
  filter(la_name == "Brighton and Hove" & education_phase == "State-funded secondary") %>%
  mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor

filtered_data <- absence %>%
  filter(education_phase == "State-funded secondary" & is.na(la_name))


ggplot() +
  geom_line(data = filtered_data, aes(x = year, y = sess_unauthorised_percent, color = region_name, group = region_name)) +
  geom_point(data = filtered_data, aes(x = year, y = sess_unauthorised_percent, color = region_name, group = region_name)) +
  geom_line(data = absence_btn, aes(x = year, y = sess_unauthorised_percent), color = "black", group = 1, size = 1) +
  geom_point(data = absence_btn, aes(x = year, y = sess_unauthorised_percent), color = "black") +
  labs(title = "Unauthorised Absence Rates Over Time \nfor State-funded Secondary Schools by Region",
       x = "Year",
       y = "Unauthorised Absence Rate") +
  theme_minimal()



```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Line plot for sess_unauth_totalreasons_rate for Brighton and Hove over all values of year 
absence_btn <- absence %>%
  filter(la_name == "Brighton and Hove" & education_phase == "State-funded secondary") %>%
  mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor

filtered_data <- absence %>%
  filter(education_phase == "State-funded secondary" & is.na(la_name))


ggplot() +
  geom_line(data = filtered_data, aes(x = year, y = enrolments_pa_10_exact_percent, color = region_name, group = region_name)) +
  geom_point(data = filtered_data, aes(x = year, y = enrolments_pa_10_exact_percent, color = region_name, group = region_name)) +
  geom_line(data = absence_btn, aes(x = year, y = enrolments_pa_10_exact_percent, color = "Brighton and Hove"), group = 1, size = 1) +
  geom_point(data = absence_btn, aes(x = year, y = enrolments_pa_10_exact_percent, color = "Brighton and Hove")) +
  labs(title = "Persistent Absence (10% or more sessions missed) Rates Over Time \nfor State-funded Secondary Schools by Region",
       x = "Year",
       y = "Persistent Absence Rate",
       color = "Region") +  # Change legend title
  theme_minimal() +
  scale_color_manual(values = c("black", brewer.pal(9, "Set1")))  # Add black for Brighton and Hove and Set1 for regions



```



```{r echo=FALSE, message=FALSE, warning=FALSE}
##Absence 2022-23 regression analysis

##All Data downloaded from here
##https://www.compare-school-performance.service.gov.uk/

#read in data for every school in the country

england_abs <- read_csv(here("data", "Performancetables_Eng_2022_23", "2022-2023", "england_abs.csv"), na = c("", "NA", "SUPP", "NP", "NE"))
england_census <- read_csv(here("data", "Performancetables_Eng_2022_23", "2022-2023", "england_census.csv"), na = c("", "NA", "SUPP", "NP", "NE"))
england_ks4final <- read_csv(here("data", "Performancetables_Eng_2022_23", "2022-2023", "england_ks4final.csv"), na = c("", "NA", "SUPP", "NP", "NE"))
england_school_information <- read_csv(here("data", "Performancetables_Eng_2022_23", "2022-2023", "england_school_information.csv"), na = c("", "NA", "SUPP", "NP", "NE"))

england_ks4final <- england_ks4final %>%
  mutate(URN = as.character(URN)) %>%
  mutate(across(TOTPUPS:PTOTENT_E_COVID_IMPACTED_PTQ_EE, ~ parse_number(as.character(.))))

england_ks4final <- england_ks4final %>%
  filter(!is.na(URN))

england_abs <- england_abs %>%
  mutate(URN = as.character(URN))

england_census <- england_census %>%
  mutate(URN = as.character(URN))

england_school_information <- england_school_information %>%
  mutate(URN = as.character(URN))

# Left join england_ks4final with england_abs
england_school_2022_23 <- england_ks4final %>%
  left_join(england_abs, by = "URN") %>%
  left_join(england_census, by = "URN") %>%
  left_join(england_school_information, by = "URN")

data_types <- sapply(england_school_2022_23, class)
england_school_2022_23_meta <- data.frame(Field = names(data_types), DataType = data_types)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#read in Brighton Secondary Schools Data
brighton_sec_schools <- read_csv("https://www.dropbox.com/scl/fi/fhzafgt27v30lmmuo084y/edubasealldata20241003.csv?rlkey=uorw43s44hnw5k9js3z0ksuuq&raw=1") %>% 
  clean_names() %>% 
  filter(la_name == "Brighton and Hove") %>% 
  filter(phase_of_education_name == "Secondary") %>% 
  filter(establishment_status_name == "Open") %>%
  st_as_sf(., coords = c("easting", "northing")) %>% 
  st_set_crs(27700)

btn_urn_list <- brighton_sec_schools %>% 
  select(urn) 

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(ggrepel)


btn_sub <- england_school_2022_23 %>%
  filter(URN %in% btn_urn_list$urn)

#P8_BANDING


library(ggplot2)
library(ggrepel)

england_school_2022_23_not_special <- england_school_2022_23 %>%
  filter(MINORGROUP != "Special school")


```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(england_school_2022_23_not_special, aes(x = P8MEA)) +
  geom_histogram(binwidth = 0.1, fill = "#b3cde3", color = "black") +  # Pastel color for the bars
  labs(title = "Distribution of P8MEA",
       x = "P8MEA",
       y = "Count") +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Order factor levels of SCHNAME.x by PERCTOT
btn_sub <- btn_sub %>%
  mutate(SCHNAME.x = factor(SCHNAME.x, levels = SCHNAME.x[order(PERCTOT)]))


# Create the histogram with vertical lines using the Set3 palette
ggplot(england_school_2022_23_not_special, aes(x = PPERSABS10)) +
  geom_histogram(binwidth = 1, fill = "grey", color = "black", alpha = 0.4) +  # New color for the bars with added transparency
  labs(title = "Percentage of Enrolments Who Are Persistent Absentees - Missing 10% \nor More of Possible Sessions Across the Full 2022/23 Academic Year - \n(All Secondary Schools England, Brighton overlaid)",
       x = "Percentage of Enrolments Who Are Persistent Absentees",
       y = "Count",
       color = "School (ordered lowest absence)") +  # Change legend title to "School"
  theme_minimal() +
  geom_vline(data = btn_sub, aes(xintercept = PPERSABS10, color = SCHNAME.x), linetype = "solid", linewidth = 1) +  # Solid vertical lines colored by SCHNAME.x
  scale_color_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for high contrast with 10 colors
  theme(legend.position = c(0.8, 0.5),  # Position legend inside the plot
        legend.background = element_rect(fill = "white", size = 0.5, linetype = "solid", color = "black")) 




```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(ggrepel)
library(RColorBrewer)

england_median <- median(england_school_2022_23_not_special$PERCTOT, na.rm = TRUE)

# Order factor levels of SCHNAME.x by PERCTOT
btn_sub <- btn_sub %>%
  mutate(SCHNAME.x = factor(SCHNAME.x, levels = SCHNAME.x[order(PERCTOT)]))

# Create the histogram with vertical lines using the Set3 palette
ggplot(england_school_2022_23_not_special, aes(x = PERCTOT)) +
  geom_histogram(binwidth = 0.5, fill = "grey", color = "black", alpha = 0.4) +  # New color for the bars with added transparency
  labs(title = "Percentage of Overall Absence (Authorised and Unauthorised) \nfor the Full 2022/23 Academic Year (All Secondary Schools England, Brighton overlaid)",
       x = "Percentage of Overall Absence",
       y = "Count",
       color = "School (ordered lowest absence)") +  # Change legend title to "School"
  theme_minimal() +
  geom_vline(data = btn_sub, aes(xintercept = PERCTOT, color = SCHNAME.x), linetype = "solid", linewidth = 1) +  # Solid vertical lines colored by SCHNAME.x
  scale_color_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for high contrast with 10 colors
  scale_x_continuous(breaks = seq(0, max(england_school_2022_23_not_special$PERCTOT, na.rm = TRUE), by = 2)) +  # Add more numbers on the x-axis
  theme(legend.position = c(0.8, 0.5),  # Position legend inside the plot
        legend.background = element_rect(fill = "white", size = 0.5, linetype = "solid", color = "black"))

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

##FSM - % disadvantaged at the end of KS4
ggplot(england_school_2022_23_not_special, aes(x = PTFSM6CLA1A

)) +
  geom_histogram(fill = "#b3cde3", color = "black") +  # Pastel color for the bars
  labs(title = "% disadvantaged at the end of KS4",
       x = "% disadvantaged at the end of KS4",
       y = "Count") +
  theme_minimal()

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Base plot with england_school_2022_23
plot <- ggplot(england_school_2022_23_not_special, aes(y = P8MEA, x = PPERSABS10, colour = OFSTEDRATING)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Add linear model line for england_school_2022_23
  labs(title = "Progress 8 vs Persistent Absence %, 2022-23",
       x = "% Enrollments who are persistently absent",
       y = "Progress 8 measure after adjustment for extreme scores") +
  theme_minimal()

# Add another layer with btn_sub points and labels with sticks
plot + 
  geom_point(data = btn_sub, aes(y = P8MEA, x = PPERSABS10), color = "black") +
  geom_smooth(data = btn_sub, aes(y = P8MEA, x = PPERSABS10), method = "lm", se = FALSE, color = "black") +  # Add linear model line for btn_sub
  geom_text_repel(data = btn_sub, aes(y = P8MEA, x = PPERSABS10, label = SCHNAME.x), color = "black", size = 3, nudge_y = c(-1.5, 1.5), force = 10, box.padding = 0.5, max.overlaps = 10, direction = "both")

ggsave(here("images","progress8_vs_persabs.png"), width = 10, height = 6, dpi = 300)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(england_school_2022_23_not_special, aes(y = P8MEA, x = PPERSABS10, colour = OFSTEDRATING)) +
geom_point(data = btn_sub, aes(y = P8MEA, x = PPERSABS10, colour = OFSTEDRATING)) +
  geom_smooth(data = btn_sub, aes(y = P8MEA, x = PPERSABS10), method = "lm", se = TRUE, color = "black") +  # Add linear model line for btn_sub
  geom_text_repel(data = btn_sub, aes(y = P8MEA, x = PPERSABS10, label = SCHNAME.x), color = "black", size = 3, nudge_y = c(-1.5, 1.5), force = 10, box.padding = 0.5, max.overlaps = 10, direction = "both") +  # Add linear model line for england_school_2022_23
  labs(title = "Progress 8 vs Persistent Absence %, 2022-23",
       x = "% Enrollments who are persistently absent",
       y = "Progress 8 measure after adjustment for extreme scores") +
  theme_minimal()

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)

#colour = "#b3cde3"

plot <- ggplot(england_school_2022_23_not_special, aes(y = P8MEA, x = PTFSM6CLA1A, colour = OFSTEDRATING)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Add linear model line for england_school_2022_23
  labs(title = "Progress 8 vs Disadvantaged Student %, 2022-23",
       x = "% Percentage of Disadvantaged Students",
       y = "Progress 8 measure after adjustment for extreme scores") +
  theme_minimal()

# Add another layer with btn_sub points and labels with sticks
plot + 
  geom_point(data = btn_sub, aes(y = P8MEA, x = PTFSM6CLA1A), color = "black") +
  geom_smooth(data = btn_sub, aes(y = P8MEA, x = PTFSM6CLA1A), method = "lm", se = FALSE, color = "black") +  # Add linear model line for btn_sub
  geom_text_repel(data = btn_sub, aes(y = P8MEA, x = PTFSM6CLA1A, label = SCHNAME.x), color = "black", size = 3, nudge_y = c(-1.5, 1.5), force = 10, box.padding = 0.5, max.overlaps = 10, direction = "both")

ggsave(here("images","progress8_vs_disadvantage.png"), width = 10, height = 6, dpi = 300)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#colour = "#b3cde3"

plot <- ggplot(england_school_2022_23_not_special, aes(y = P8MEA, x = PERCTOT, colour = OFSTEDRATING)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Add linear model line for england_school_2022_23
  labs(title = "Progress 8 vs Overall Absence %, 2022-23",
       x = "% Percentage of overall absence (authorised and unauthorised)",
       y = "Progress 8 measure after adjustment for extreme scores") +
  theme_minimal()

# Add another layer with btn_sub points and labels with sticks
plot + 
  geom_point(data = btn_sub, aes(y = P8MEA, x = PERCTOT), color = "black") +
  geom_smooth(data = btn_sub, aes(y = P8MEA, x = PERCTOT), method = "lm", se = FALSE, color = "black") +  # Add linear model line for btn_sub
  geom_text_repel(data = btn_sub, aes(y = P8MEA, x = PERCTOT, label = SCHNAME.x), color = "black", size = 3, nudge_y = c(-1.5, 1.5), force = 10, box.padding = 0.5, max.overlaps = 10, direction = "both")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot <- ggplot(england_school_2022_23_not_special, aes(y = PTFSM6CLA1A, x = PERCTOT, colour = OFSTEDRATING)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Add linear model line for england_school_2022_23
  labs(title = "FSM % vs Overall Absence %, 2022-23",
       x = "% FSM/Disadvantaged",
       y = "% Percentage of overall absence (authorised and unauthorised)") +
  theme_minimal()

plot
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
cor <- cor(england_school_2022_23_not_special$PTFSM6CLA1A, england_school_2022_23_not_special$PERCTOT, use = "complete.obs")

cor
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
## regression model

library(gglm)
library(car)
library(jtools)
library(kableExtra)

# Create a linear model

model <- lm(P8MEA ~ PPERSABS10 + PTFSM6CLA1A + OFSTEDRATING, data = england_school_2022_23_not_special)

vif_values <- car::vif(model)
vif_values

summ(model, scale = TRUE)

#gglm(model)

```
```{r}
plot_summs(model, inner_ci_level = .9, scale = TRUE)
```

