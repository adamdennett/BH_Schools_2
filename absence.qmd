---
title: "Let's Talk About Absence"
author: "Professor Adam Dennett FRGS FAcSS, Professor of Urban Analytics, Bartlett Centre for Advanced Spatial Analysis, University College London - a.dennett@ucl.ac.uk - @adam_dennett"
published-title: 12/12/24
format: html
editor: visual
bibliography: references.bib
---

```{r echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, include=FALSE, results='hide'}
library(tidyr)
library(dplyr)
library(writexl)
library(tidyverse)
library(here)
library(janitor)
library(sf)
library(usethis)
library(tmap)
library(readxl)
library(r5r)
library(RColorBrewer)
library(accessibility)
library(data.table)
library(ggplot2)
library(interp)
library(h3jsr)
library(h3r)
library(osmextract)
library(stplanr)
library(od)
library(tidytransit)

```

## Absence/Attendance and Attainment?

In this piece I am going to change the focus of the conversation and look at something which has thus far been absent (excuse the pun) from any of the conversations about the school system in Brighton. The issue of absence/attendance and its importance for educational outcomes.

### Improving Educational Outcomes

The Council's premise in the very first slide shown in the engagement exercise back in October, was that Brighton and Hove has a large attainment gap and is failing its most disadvantaged pupils. Now, I have since refuted that claim here - <https://adamdennett.github.io/BH_Schools_2/stain_removal.html> - and shown that Brighton is not performing badly as a city and indeed is above the national median in terms of disadvantaged attainment.

However, it is clear that disadvantage and attainment is still an important topic for the council and is one of the main drivers behind the plans in the consultation. The new proposal documentation ([supporting documents here](https://democracy.brighton-hove.gov.uk/mgAi.aspx?ID=102291)) states in 3.7 that the council wants a system that:

*"delivers children's outcomes which are good and improving especially for those at risk of disadvantage"*

and under 3.9 that:

*"the proposals put forward were designed to include: a) Better equality of outcomes – results not driven by economic advantage. b) Deliver a ‘comprehensive’ offer from our city schools as a more mixed pupil intake creates better outcomes for disadvantaged pupils."*

#### Trick or Treatment?

The underpinning assumptions in those statements above are that economic advantage/disadvantage are the main drivers of results in the city and the main remedy is through some kind of economic mixing in intakes. But in much the same way as when we go to the doctor, we expect an accurate diagnosis and corresponding efficatious treatment, we all know that unfortunately, sometimes, neither diagnosis nor treatment are correct.

We know the council's prescribed treatment has been influenced quite heavily by some of the work of Stephen Gorard (<https://theconversation.com/poorer-pupils-do-worse-at-school-heres-how-to-reduce-the-attainment-gap-205535>), but is the diagnosis for the city even correct? Before prescribing a treatment, should we have not carried out a thorough examination of the patient in case a more serious underlying ailment is causing the symptoms?

Without wanting to strain the metaphor further, how do we know for sure that a lack of mixing is indeed the main factor holding back disadvantaged attainment? What if it is not? And if it is not, what is more important? And if there are more important factors, might there be more effective routes to minimising disadvantged educational outcomes that could offer better or faster results, and indeed do so without the levels of disruption currently on the table?

These are very important questions to ask, not least because under the current proposals, one of the experimental 'treatments' being prescribed by the council is forced mixing in schools through artificially reducing places in schools for local students and '[busing](https://en.wikipedia.org/wiki/Desegregation_busing)' significant numbers of students from some neighbouroods (some by 'choice' and some through 'displacement' [- see the PGS explainer here](https://www.parentsupport.group/wp-content/uploads/2024/12/schools_admissions_2026_explainer_v1.0_2024-12-4-final.pdf)) to schools a long way from their homes. This kind of forced mixing not only has a questionable history and efficacy in other contexts (see [@rossell1990] and others for the US history - a very different context, but same underlying idea), but has huge negative financial, environmental and social implications for our city (many of which were [raised in the Parent Support Group's latest deputation at the Labour Cabinet meeting in November](https://www.parentsupport.group/deputation-to-brighton-council-cabinet-5th-dec-2024/)) which have thus-far been ignored by those advocating for the proposals.

And as I will show below, it is the case that the treatment currently being prescribed by the council, might even make things much worse - again, at risk of stretching the metaphor too far, this could be akin to the approach of doctors in the Crimean war, attempting treatments with the best of intentions, but with a deadly lack of understanding.

### Is there anything more important than social mixing holding back educational attainment, particularly for disadvantaged pupils?

The short answer is: Yes, yes there is. The longer answer is there are lots of things; from raw income deprivation, requiring SEN support to simply moving schools (see p8 of [@claymore2023] to see the relative effects of some of these) which can impact attainment. But there is one factor, over an above everything else, that affects attainment the most: **Absence from School.**

## Absence

Now at this point, you'd be forgiven for shouting "***well that's bloody obvious, I could have told you that!***" - which makes it all the more surprising that it has barely surfaced in the narrative during this whole Brighton Secondary School Admissions engagement/consultation process.

I genuinely don't know why it hasn't, but again the rush to consultation and a general lack of due care and attention in gathering relevant evidence throughout, are probably in the blame line-up - of course assuming that the publicly stated aims actually align with a desire to conduct evidence-based policy.

### The Evidence - the literature

I could get all academic and cite a bunch of papers and government reports, at this juncture, which detail the important role that absence/attendance plays in educational outcomes over and above everything else, but we've "had enough of experts", right? . No? Oh OK then. First up a recent [report for the Government's Social Mobility Commission](https://www.gov.uk/government/publications/against-the-odds/against-the-odds-achieving-greater-progress-for-secondary-students-facing-socio-economic-disadvantage), where [@riordan2021] state:

***"Our statistical models indicate that the strongest predictive factor of the progress made by pupil premium \[disadvantaged\] students is the school’s absence rate"***

***"schools with lower absence rates have smaller progress gaps; pupil premium students progress more at schools with lower absence rates; This correlation is regardless of whether they begin with low, medium or high rates of absence."***

***"These findings concur with previous research and we share their interpretation too, that this correlation is most likely to be causal. This is because there is an intuitive underlying causal mechanism: students not in school are less likely to learn the school curriculum."***

Next, [@claymore2023a] (already citied above) in a paper titled: "[Being Present: the Power of Attendance and Stability for Stability for Disadvantaged Pupils](https://www.nfer.ac.uk/publications/being-present-the-power-of-attendance-and-stability-for-disadvantaged-pupils/)" states:

***"On average, the association between being absent from school and KS4 outcomes is worse for disadvantaged pupils than their more affluent peers"***

***"Supporting secondary schools to reduce absence, improve behaviour and support within-secondary phase transfers are all key areas of policy focus to boost outcomes of disadvantaged pupils and reduce group gaps in progress and attainment."***

***"over half of the gap in outcomes between disadvantaged pupils and their more affluent peers is associated with the underlying group differences in absence, exclusion and pupil transfer rates. Improving these underlying factors for disadvantaged pupils should therefore substantially boost outcomes for the group"***

I could also go on to cite work by the National Governance Association [@nga2024] on improving School Attendance, or the Department for Education's extensive resources on why improving school attendance is important[@dfe2023] [@dfe2024], but I think you are starting to get the picture. It makes sense, right? If you don't go to school, it's harder to learn and achieve.

So the literature clearly says absence is important but:

-   Is it important for Brighton and Hove?

-   And if it is, is it more or less important than social mixing or concentrations of disadvantage in the city?

Fortunately, as has been the case throughout this whole engagement/consultation exercise, data and analysis can shed some light and help us answer these questions.

```{r echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, include=FALSE, results='hide'}
#References

#https://educationhub.blog.gov.uk/2023/05/18/school-attendance-important-risks-missing-day/

#https://www.nga.org.uk/knowledge-centre/improving-school-attendance/

#https://www.nga.org.uk/knowledge-centre/disadvantage-in-education/
#
#https://www.nfer.ac.uk/publications/being-present-the-power-of-attendance-and-stability-for-disadvantaged-pupils/ 
  
#https://www.gov.uk/government/publications/against-the-odds

##this one has the gold
#https://www.gov.uk/government/publications/against-the-odds/against-the-odds-achieving-greater-progress-for-secondary-students-facing-socio-economic-disadvantage
# 
# "Our statistical models indicate that the strongest predictive factor of the progress made by pupil premium students is the school’s absence rate:[footnote 31]"
# 
# "schools with lower absence rates have smaller progress gaps
# pupil premium students progress more at schools with lower absence rates
# This correlation is regardless of whether they begin with low, medium or high rates of absence."
# 
# "These findings concur with previous research and we share their interpretation too, that this correlation is most likely to be causal. This is because there is an intuitive underlying causal mechanism: students not in school are less likely to learn the school curriculum.[footnote 32]"

#https://assets.publishing.service.gov.uk/media/66bf300da44f1c4c23e5bd1b/Working_together_to_improve_school_attendance_-_August_2024.pdf 


```

### The Evidence - the data

#### What is absence and how is absence measured?

There are lots of different reasons why students miss school, for example to attend medical appointments, illness, religious observance, study leave etc. these are likely to be counted as valid reasons and 'authorised' by schools. Then there are reasons that are 'unauthorised' and these might include things like going on holiday, but also apply to students that might have to stay home to care for family members as well as truancy - i.e. intentionally missing school without permission to be absent.

Reasons for truancy or 'school refusal' can be complex and vary between different children, and I won't go into them here (various sources of information elsewhere if you are interested, [including here](https://notfineinschool.co.uk/research)), but one of the ways in which longer-term absence is measured is if more than 10% of the sessions in a school year are missed. This is often referred to as '**Persistent Absence**' in the data.

#### Data Sources

The Department for Education (DfE) publishes various datasets online which cover things like attainment and absence at both the Local Authority level and at the level of individual schools. We will start with this dataset - <https://explore-education-statistics.service.gov.uk/data-catalogue/data-set/be024b4d-4f91-40e4-8a58-50dc53dcc93f> - "Absence by geographic level - autumn and spring terms combined" which allows us to look at absence in secondary schools across all local authorities from 2016 until 2023.

**Question: What is the national picture of persistent absence and how does Brighton and Hove compare?**

### Persistent Absence - The National Picture

```{r echo=FALSE, message=FALSE, warning=FALSE}
#unauthorised absence

#https://explore-education-statistics.service.gov.uk/data-catalogue/data-set/be024b4d-4f91-40e4-8a58-50dc53dcc93f

##school performance
#https://www.compare-school-performance.service.gov.uk/


#from here - https://explore-education-statistics.service.gov.uk/data-catalogue/data-set/be024b4d-4f91-40e4-8a58-50dc53dcc93f
absence <- read_csv("https://explore-education-statistics.service.gov.uk/data-catalogue/data-set/be024b4d-4f91-40e4-8a58-50dc53dcc93f/csv")

absence_meta <- as.data.frame(names(absence))

absence <- absence %>% 
  mutate(year = as.numeric(substr(time_period, 1, 4)))


# Filter the dataframe
absence_2022 <- absence %>%
  filter(year == "2022" & !is.na(la_name) & education_phase == "State-funded secondary")

brighton_rate_2022 <- absence_2022 %>%
  filter(la_name == "Brighton and Hove") %>%
  pull(sess_unauthorised_percent)

library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(dplyr)

# Ensure the data has necessary columns and correct types
absence <- absence %>%
  mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor

# Ensure the data has necessary columns and correct types
absence_secondary <- absence %>%
  filter(education_phase == "State-funded secondary") %>%
  mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor

btn_absence_secondary <- absence_secondary %>%
  filter(la_name == "Brighton and Hove")

eng_absence_secondary <- absence_secondary %>%
  filter(geographic_level == "National")

medians <- absence_secondary %>%
  group_by(year) %>%
  summarize(median_sess_unauthorised_percent = median(sess_unauthorised_percent, na.rm = TRUE))


# ggplot(absence_secondary, aes(x = sess_unauthorised_percent, fill = factor(year))) +
#   geom_histogram(binwidth = 0.2, alpha = 1, position = "identity") +
#   geom_vline(data = medians, aes(xintercept = median_sess_unauthorised_percent, color = "England Median"), linetype = "solid", size = 1) +
#   geom_vline(data = btn_absence_secondary, aes(xintercept = sess_unauthorised_percent, color = "Brighton and Hove"), linetype = "dashed", linewidth = 1) +
#   facet_wrap(~ year) +  # Facet by year
#   labs(title = "Unauthorised Absence Rates (% sessions missed) \nfor State-funded Secondary Schools by Year",
#        x = "Unauthorised Absence Rate",
#        y = "Count",
#        fill = "Year",
#        color = "") +  # Change legend title
#   theme_minimal() +
#   scale_fill_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for fill colors
#   scale_color_manual(values = c("England Median" = "black", "Brighton and Hove" = "blue")) +  # Correct manual scale
#   guides(color = guide_legend(override.aes = list(linetype = c("dashed", "solid"), 
#                                                    shape = c(NA, NA), 
#                                                    size = c(1, 1))))



```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# medians <- absence_secondary %>%
#   group_by(year) %>%
#   summarize(median_sess_overall_percent = median(sess_overall_percent, na.rm = TRUE))
# 
# ggplot(absence_secondary, aes(x = sess_overall_percent, fill = factor(year))) +
#   geom_histogram(binwidth = 0.2, alpha = 1, position = "identity") +
#   geom_vline(data = medians, aes(xintercept = median_sess_overall_percent, color = "England Median"), linetype = "solid", size = 1) +
#   geom_vline(data = btn_absence_secondary, aes(xintercept = sess_overall_percent, color = "Brighton and Hove"), linetype = "dashed", linewidth = 1) +
#   facet_wrap(~ year) +  # Facet by year
#   labs(title = "Overall Absence Rates (% sessions missed) \nfor State-funded Secondary Schools by Year",
#        x = "Overall Absence Rate",
#        y = "Count",
#        fill = "Year",
#        color = "") +  # Change legend title
#   theme_minimal() +
#   scale_fill_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for fill colors
#   scale_color_manual(values = c("England Median" = "black", "Brighton and Hove" = "blue")) +  # Correct manual scale
#   guides(color = guide_legend(override.aes = list(linetype = c("dashed", "solid"), 
#                                                    shape = c(NA, NA), 
#                                                    size = c(1, 1))))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# medians <- absence_secondary %>%
#   group_by(year) %>%
#   summarize(median_enrolments_pa_50_exact_percent = median(enrolments_pa_50_exact_percent, na.rm = TRUE))
# 
# ggplot(absence_secondary, aes(x = enrolments_pa_50_exact_percent, fill = factor(year))) +
#   geom_histogram(binwidth = 0.2, alpha = 1, position = "identity") +
#   geom_vline(data = medians, aes(xintercept = median_enrolments_pa_50_exact_percent, color = "England Median"), linetype = "solid", size = 1) +
#   geom_vline(data = btn_absence_secondary, aes(xintercept = enrolments_pa_50_exact_percent, color = "Brighton and Hove"), linetype = "dashed", linewidth = 1) +
#   facet_wrap(~ year) +  # Facet by year
#   labs(title = "Percentage of persistent absentees - 50% or more sessions missed -    \nfor State-funded Secondary Schools by Year",
#        x = "Percentage of persistent absentees",
#        y = "Count",
#        fill = "Year",
#        color = "") +  # Change legend title
#   theme_minimal() +
#   scale_fill_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for fill colors
#   scale_color_manual(values = c("England Median" = "black", "Brighton and Hove" = "blue")) +  # Correct manual scale
#   guides(color = guide_legend(override.aes = list(linetype = c("dashed", "solid"), 
#                                                    shape = c(NA, NA), 
#                                                    size = c(1, 1))))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
medians <- absence_secondary %>%
  group_by(year) %>%
  summarize(median_enrolments_pa_10_exact_percent = median(enrolments_pa_10_exact_percent, na.rm = TRUE))

ggplot(absence_secondary, aes(x = enrolments_pa_10_exact_percent, fill = factor(year))) +
  geom_histogram(binwidth = 0.5, alpha = 1, position = "identity") +
  geom_vline(data = medians, aes(xintercept = median_enrolments_pa_10_exact_percent, color = "England Median"), linetype = "solid", size = 1) +
  geom_vline(data = btn_absence_secondary, aes(xintercept = enrolments_pa_10_exact_percent, color = "Brighton and Hove"), linetype = "dashed", linewidth = 1) +
  facet_wrap(~ year) +  # Facet by year
  labs(title = "Percentage of persistent absentees - 10% or more sessions missed -    \nfor State-funded Secondary Schools by Year",
       x = "Percentage of persistent absentees",
       y = "Count",
       fill = "Year",
       color = "") +  # Change legend title
  theme_minimal() +
  scale_fill_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for fill colors
  scale_color_manual(values = c("England Median" = "black", "Brighton and Hove" = "blue")) +  # Correct manual scale
  guides(color = guide_legend(override.aes = list(linetype = c("dashed", "solid"), 
                                                   shape = c(NA, NA), 
                                                   size = c(1, 1))))
```

***Figure 1 - Persistent Absence in State Secondary Schools, 2016/17 to 2023/24; All Local Authorities in England. Brighton and Hove and England Overlaid.***

There are couple of things worth pointing out in the plot above:

-   The problem of persistent absence has increased massively since 2016/17, with stark change in the years after the COVID-19 pandemic, where the median persistent absence had been declining and has reduced to about 12% by 2020, but shot up to over 25% after COVID and is still at about 24% in the most recent data for 2023/24.

-   At the same time, the variance has increased (meaning the median is less representative of the whole data) - with more Local Authorities having rates of persistent absence well above average, with some having over 1/3 of students missing 10% or more of school.

-   For Brighton and Hove this situation is bad. Persistent absence has been above average since 2016/17 and while it had declined to only just above the national average in 2020/21, since the Pandemic, the rates of persistent absence have been well above the national average, in 2023/24 topping out at 28%, 4% above the national average of 24%.

```{r echo=FALSE, message=FALSE, warning=FALSE}
absence_2023 <- absence_secondary %>%
  filter(year == "2023")


mean_value <- mean(absence_2023$enrolments_pa_10_exact_percent, na.rm = TRUE)
sd_value <- sd(absence_2023$enrolments_pa_10_exact_percent, na.rm = TRUE)

absence_2023 <- absence_2023 %>%
  mutate(deviation_status = case_when(
    enrolments_pa_10_exact_percent < mean_value - 1.96 * sd_value ~ "Below 1.96 SD",
    enrolments_pa_10_exact_percent > mean_value + 1.96 * sd_value ~ "Above 1.96 SD",
    enrolments_pa_10_exact_percent < mean_value - 1.65 * sd_value & enrolments_pa_10_exact_percent >= mean_value - 1.96 * sd_value ~ "Below 1.65 SD",
    enrolments_pa_10_exact_percent > mean_value + 1.65 * sd_value & enrolments_pa_10_exact_percent <= mean_value + 1.96 * sd_value ~ "Above 1.65 SD",
    TRUE ~ "Within 1.65 SD"
  ))

iqr_values <- quantile(absence_2023$enrolments_pa_10_exact_percent, probs = c(0.25, 0.75), na.rm = TRUE)
lower_bound <- iqr_values[1]
upper_bound <- iqr_values[2]


ggplot(absence_2023, aes(x = enrolments_pa_10_exact_percent, fill = deviation_status)) +
  geom_histogram(binwidth = 0.5, alpha = 0.8, position = "identity") +
  geom_vline(xintercept = mean_value, color = "black", linetype = "solid", size = 1) +
  #geom_vline(xintercept = mean_value + 1.96 * sd_value, color = "#E41A1C", linetype = "dashed", size = 1) +
  #geom_vline(xintercept = mean_value - 1.96 * sd_value, color = "#E41A1C", linetype = "dashed", size = 1) +
  #geom_vline(xintercept = mean_value + 1.65 * sd_value, color = "#377EB8", linetype = "dotted", size = 1) +
  #geom_vline(xintercept = mean_value - 1.65 * sd_value, color = "#377EB8", linetype = "dotted", size = 1) +
  geom_vline(xintercept = lower_bound, color = "#377EB8", linetype = "dashed", size = 1) +
  geom_vline(xintercept = upper_bound, color = "#377EB8", linetype = "dashed", size = 1) +
  geom_vline(xintercept = 28.19426, color = "#4DAF4A", linetype = "solid", size = 1) +
  annotate("text", x = 28.19426, y = 6, label = "Brighton and Hove", color = "#4DAF4A", angle = 90, vjust = 1.5, hjust = 0) +
  labs(title = "Percentage of Persistent Absentees - 10% or More Sessions Missed (2023/24) \nfor State-funded Secondary Schools",
       x = "Percentage of Persistent Absentees",
       y = "Count",
       fill = "Deviation Status") +  # Change legend title
  theme_minimal() +
  scale_fill_manual(values = c("Below 1.96 SD" = "#FF7F00", "Above 1.96 SD" = "#FF7F00", 
                               "Below 1.65 SD" = "#984EA3", "Above 1.65 SD" = "#984EA3", 
                               "Within 1.65 SD" = "#A6CEE3"))  # Use custom colors for SD classifications


```

***Figure 2 - Persistent Absence in State Secondary Schools, All Local Authorities in England 2023/24. Brighton and Hove, Mean, Interquartile Range and Outliers at 90% and 95% added.***

-   If we look at just 2023/24 (Figure 2 above), we can see that Brighton and Hove is not quite an outlier (above the 90% percentile at 1.65 standard deviations from the mean) in terms of persistent absence, but it is well above the national average and outside the interquartile range (where 50% of local authorities would lie) with a rate of 28.2%.

-   This is a slightly wordy statistical way of saying that the persistent absence situation in Brighton and Hove raises interest and is much worse than most other places in the country.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Histogram with vertical lines and labels
# 
# # Line plot for sess_unauth_totalreasons_rate for Brighton and Hove over all values of year 
# 
# absence_btn <- absence %>%
#   filter(la_name == "Brighton and Hove" & education_phase == "State-funded secondary") %>%
#   mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor
# 
# ggplot(absence_btn, aes(x = year, y = sess_unauthorised_percent, group = 1)) + 
#   geom_line(color = "black") +
#   geom_point() +
#   labs(title = "Unauthorised Absence Rates Over Time for Brighton and Hove", 
#        x = "Year", 
#        y = "Unauthorised Absence Rate") + 
#   theme_minimal()
# 

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# # Line plot for sess_unauth_totalreasons_rate for Brighton and Hove over all values of year 
# absence_btn <- absence %>%
#   filter(la_name == "Brighton and Hove" & education_phase == "State-funded secondary") %>%
#   mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor
# 
# filtered_data <- absence %>%
#   filter(education_phase == "State-funded secondary" & is.na(la_name))
# 
# 
# ggplot() +
#   geom_line(data = filtered_data, aes(x = year, y = sess_unauthorised_percent, color = region_name, group = region_name)) +
#   geom_point(data = filtered_data, aes(x = year, y = sess_unauthorised_percent, color = region_name, group = region_name)) +
#   geom_line(data = absence_btn, aes(x = year, y = sess_unauthorised_percent), color = "black", group = 1, size = 1) +
#   geom_point(data = absence_btn, aes(x = year, y = sess_unauthorised_percent), color = "black") +
#   labs(title = "Unauthorised Absence Rates Over Time \nfor State-funded Secondary Schools by Region",
#        x = "Year",
#        y = "Unauthorised Absence Rate") +
#   theme_minimal()



```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Line plot for sess_unauth_totalreasons_rate for Brighton and Hove over all values of year 
absence_btn <- absence %>%
  filter(la_name == "Brighton and Hove" & education_phase == "State-funded secondary") %>%
  mutate(year = as.factor(substr(time_period, 1, 4)))  # Extract year and convert to factor

filtered_data <- absence %>%
  filter(education_phase == "State-funded secondary" & is.na(la_name))


ggplot() +
  geom_line(data = filtered_data, aes(x = year, y = enrolments_pa_10_exact_percent, color = region_name, group = region_name)) +
  geom_point(data = filtered_data, aes(x = year, y = enrolments_pa_10_exact_percent, color = region_name, group = region_name)) +
  geom_line(data = absence_btn, aes(x = year, y = enrolments_pa_10_exact_percent, color = "Brighton and Hove"), group = 1, size = 1) +
  geom_point(data = absence_btn, aes(x = year, y = enrolments_pa_10_exact_percent, color = "Brighton and Hove")) +
  labs(title = "Persistent Absence (10% or more sessions missed) Rates Over Time \nfor State-funded Secondary Schools by Region",
       x = "Year",
       y = "Persistent Absence Rate",
       color = "Region") +  # Change legend title
  theme_minimal() +
  scale_color_manual(values = c("black", brewer.pal(9, "Set1")))  # Add black for Brighton and Hove and Set1 for regions



```

***Figure 3 - Persistent Absence Over Time, Compared to Regions in England***

-   If we compare Brighton and Hove with other areas in the county - here I have chosen regions simply because there are fewer of them and they can fit on a single graph relatively tidily - we can see that Persistent Absence is worse in the Local Authority than it is in any other region in the country.

### Persistent Absence - The Local Picture

```{r echo=FALSE, message=FALSE, warning=FALSE}
##Absence 2022-23 regression analysis

##All Data downloaded from here
##https://www.compare-school-performance.service.gov.uk/

#read in data for every school in the country

england_abs <- read_csv(here("data", "Performancetables_Eng_2022_23", "2022-2023", "england_abs.csv"), na = c("", "NA", "SUPP", "NP", "NE"))
england_census <- read_csv(here("data", "Performancetables_Eng_2022_23", "2022-2023", "england_census.csv"), na = c("", "NA", "SUPP", "NP", "NE"))
england_ks4final <- read_csv(here("data", "Performancetables_Eng_2022_23", "2022-2023", "england_ks4final.csv"), na = c("", "NA", "SUPP", "NP", "NE"))
england_school_information <- read_csv(here("data", "Performancetables_Eng_2022_23", "2022-2023", "england_school_information.csv"), na = c("", "NA", "SUPP", "NP", "NE"))

england_ks4final <- england_ks4final %>%
  mutate(URN = as.character(URN)) %>%
  mutate(across(TOTPUPS:PTOTENT_E_COVID_IMPACTED_PTQ_EE, ~ parse_number(as.character(.))))

england_ks4final <- england_ks4final %>%
  filter(!is.na(URN))

england_abs <- england_abs %>%
  mutate(URN = as.character(URN))

england_census <- england_census %>%
  mutate(URN = as.character(URN))

england_school_information <- england_school_information %>%
  mutate(URN = as.character(URN))

# Left join england_ks4final with england_abs
england_school_2022_23 <- england_ks4final %>%
  left_join(england_abs, by = "URN") %>%
  left_join(england_census, by = "URN") %>%
  left_join(england_school_information, by = "URN")

data_types <- sapply(england_school_2022_23, class)
england_school_2022_23_meta <- data.frame(Field = names(data_types), DataType = data_types)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#read in Brighton Secondary Schools Data
brighton_sec_schools <- read_csv("https://www.dropbox.com/scl/fi/fhzafgt27v30lmmuo084y/edubasealldata20241003.csv?rlkey=uorw43s44hnw5k9js3z0ksuuq&raw=1") %>% 
  clean_names() %>% 
  filter(la_name == "Brighton and Hove") %>% 
  filter(phase_of_education_name == "Secondary") %>% 
  filter(establishment_status_name == "Open") %>%
  st_as_sf(., coords = c("easting", "northing")) %>% 
  st_set_crs(27700)

btn_urn_list <- brighton_sec_schools %>% 
  select(urn) 

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(ggrepel)


btn_sub <- england_school_2022_23 %>%
  filter(URN %in% btn_urn_list$urn)

#P8_BANDING


library(ggplot2)
library(ggrepel)

england_school_2022_23_not_special <- england_school_2022_23 %>%
  filter(MINORGROUP != "Special school")


```



```{r echo=FALSE, message=FALSE, warning=FALSE}

# Order factor levels of SCHNAME.x by PERCTOT
btn_sub <- btn_sub %>%
  mutate(SCHNAME.x = factor(SCHNAME.x, levels = SCHNAME.x[order(PERCTOT)]))


# Create the histogram with vertical lines using the Set3 palette
ggplot(england_school_2022_23_not_special, aes(x = PPERSABS10)) +
  geom_histogram(binwidth = 1, fill = "grey", alpha = 0.4) +  # New color for the bars with added transparency
  labs(title = "Percentage of Enrolments Who Are Persistent Absentees - Missing 10% \nor More of Possible Sessions Across the Full 2022/23 Academic Year - \n(All Secondary Schools England, Brighton overlaid)",
       x = "Percentage of Enrolments Who Are Persistent Absentees",
       y = "Count",
       color = "School (ordered lowest absence)") +  # Change legend title to "School"
  theme_minimal() +
  geom_vline(data = btn_sub, aes(xintercept = PPERSABS10, color = SCHNAME.x), linetype = "solid", linewidth = 1) +  # Solid vertical lines colored by SCHNAME.x
  scale_color_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for high contrast with 10 colors
  theme(legend.position = c(0.8, 0.5),  # Position legend inside the plot
        legend.background = element_rect(fill = "white", size = 0.5, linetype = "solid", color = "black")) 




```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# library(ggplot2)
# library(ggrepel)
# library(RColorBrewer)
# 
# england_median <- median(england_school_2022_23_not_special$PERCTOT, na.rm = TRUE)
# 
# # Order factor levels of SCHNAME.x by PERCTOT
# btn_sub <- btn_sub %>%
#   mutate(SCHNAME.x = factor(SCHNAME.x, levels = SCHNAME.x[order(PERCTOT)]))
# 
# # Create the histogram with vertical lines using the Set3 palette
# ggplot(england_school_2022_23_not_special, aes(x = PERCTOT)) +
#   geom_histogram(binwidth = 0.5, fill = "grey", color = "black", alpha = 0.4) +  # New color for the bars with added transparency
#   labs(title = "Percentage of Overall Absence (Authorised and Unauthorised) \nfor the Full 2022/23 Academic Year (All Secondary Schools England, Brighton overlaid)",
#        x = "Percentage of Overall Absence",
#        y = "Count",
#        color = "School (ordered lowest absence)") +  # Change legend title to "School"
#   theme_minimal() +
#   geom_vline(data = btn_sub, aes(xintercept = PERCTOT, color = SCHNAME.x), linetype = "solid", linewidth = 1) +  # Solid vertical lines colored by SCHNAME.x
#   scale_color_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for high contrast with 10 colors
#   scale_x_continuous(breaks = seq(0, max(england_school_2022_23_not_special$PERCTOT, na.rm = TRUE), by = 2)) +  # Add more numbers on the x-axis
#   theme(legend.position = c(0.8, 0.5),  # Position legend inside the plot
#         legend.background = element_rect(fill = "white", size = 0.5, linetype = "solid", color = "black"))

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# ggplot(england_school_2022_23_not_special, aes(x = P8MEA)) +
#   geom_histogram(binwidth = 0.1, fill = "#b3cde3", color = "black") +  # Pastel color for the bars
#   labs(title = "Distribution of P8MEA",
#        x = "P8MEA",
#        y = "Count") +
#   theme_minimal()

btn_sub <- btn_sub %>%
  mutate(SCHNAME.x = factor(SCHNAME.x, levels = SCHNAME.x[order(P8MEA)]))

ggplot(england_school_2022_23_not_special, aes(x = P8MEA)) +
  geom_histogram(binwidth = 0.1, fill = "grey", alpha = 0.4) +  # New color for the bars with added transparency
  labs(title = "Progress 8 Measure Across the Full 2022/23 Academic Year - \n(All Secondary Schools England, Brighton overlaid)",
       x = "Progress 8 Measure",
       y = "Count",
       color = "School (ordered lowest Progress8)") +  # Change legend title to "School"
  theme_minimal() +
  geom_vline(data = btn_sub, aes(xintercept = P8MEA, color = SCHNAME.x), linetype = "solid", linewidth = 1) +  # Solid vertical lines colored by SCHNAME.x
  scale_color_manual(values = brewer.pal(10, "Set3")) +  # Use Set3 palette for high contrast with 10 colors
  theme(legend.position = c(0.25, 0.5),  # Position legend inside the plot
        legend.background = element_rect(fill = "white", size = 0.5, linetype = "solid", color = "black"))


```

```{r echo=FALSE, message=FALSE, warning=FALSE}

##FSM - % disadvantaged at the end of KS4
ggplot(england_school_2022_23_not_special, aes(x = PTFSM6CLA1A

)) +
  geom_histogram(fill = "#b3cde3", color = "black") +  # Pastel color for the bars
  labs(title = "% disadvantaged at the end of KS4",
       x = "% disadvantaged at the end of KS4",
       y = "Count") +
  theme_minimal()

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Base plot with england_school_2022_23
plot <- ggplot(england_school_2022_23_not_special, aes(y = P8MEA, x = PPERSABS10, colour = OFSTEDRATING)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Add linear model line for england_school_2022_23
  labs(title = "Progress 8 vs Persistent Absence %, 2022-23",
       x = "% Enrollments who are persistently absent",
       y = "Progress 8 measure after adjustment for extreme scores") +
  theme_minimal()

# Add another layer with btn_sub points and labels with sticks
plot + 
  geom_point(data = btn_sub, aes(y = P8MEA, x = PPERSABS10), color = "black") +
  geom_smooth(data = btn_sub, aes(y = P8MEA, x = PPERSABS10), method = "lm", se = FALSE, color = "black") +  # Add linear model line for btn_sub
  geom_text_repel(data = btn_sub, aes(y = P8MEA, x = PPERSABS10, label = SCHNAME.x), color = "black", size = 3, nudge_y = c(-1.5, 1.5), force = 10, box.padding = 0.5, max.overlaps = 10, direction = "both")

ggsave(here("images","progress8_vs_persabs.png"), width = 10, height = 6, dpi = 300)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(england_school_2022_23_not_special, aes(y = P8MEA, x = PPERSABS10, colour = OFSTEDRATING)) +
geom_point(data = btn_sub, aes(y = P8MEA, x = PPERSABS10, colour = OFSTEDRATING)) +
  geom_smooth(data = btn_sub, aes(y = P8MEA, x = PPERSABS10), method = "lm", se = TRUE, color = "black") +  # Add linear model line for btn_sub
  geom_text_repel(data = btn_sub, aes(y = P8MEA, x = PPERSABS10, label = SCHNAME.x), color = "black", size = 3, nudge_y = c(-1.5, 1.5), force = 10, box.padding = 0.5, max.overlaps = 10, direction = "both") +  # Add linear model line for england_school_2022_23
  labs(title = "Progress 8 vs Persistent Absence %, 2022-23",
       x = "% Enrollments who are persistently absent",
       y = "Progress 8 measure after adjustment for extreme scores") +
  theme_minimal()

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)

#colour = "#b3cde3"

plot <- ggplot(england_school_2022_23_not_special, aes(y = P8MEA, x = PTFSM6CLA1A, colour = OFSTEDRATING)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Add linear model line for england_school_2022_23
  labs(title = "Progress 8 vs Disadvantaged Student %, 2022-23",
       x = "% Percentage of Disadvantaged Students",
       y = "Progress 8 measure after adjustment for extreme scores") +
  theme_minimal()

# Add another layer with btn_sub points and labels with sticks
plot + 
  geom_point(data = btn_sub, aes(y = P8MEA, x = PTFSM6CLA1A), color = "black") +
  geom_smooth(data = btn_sub, aes(y = P8MEA, x = PTFSM6CLA1A), method = "lm", se = FALSE, color = "black") +  # Add linear model line for btn_sub
  geom_text_repel(data = btn_sub, aes(y = P8MEA, x = PTFSM6CLA1A, label = SCHNAME.x), color = "black", size = 3, nudge_y = c(-1.5, 1.5), force = 10, box.padding = 0.5, max.overlaps = 10, direction = "both")

ggsave(here("images","progress8_vs_disadvantage.png"), width = 10, height = 6, dpi = 300)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#colour = "#b3cde3"

plot <- ggplot(england_school_2022_23_not_special, aes(y = P8MEA, x = PERCTOT, colour = OFSTEDRATING)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Add linear model line for england_school_2022_23
  labs(title = "Progress 8 vs Overall Absence %, 2022-23",
       x = "% Percentage of overall absence (authorised and unauthorised)",
       y = "Progress 8 measure after adjustment for extreme scores") +
  theme_minimal()

# Add another layer with btn_sub points and labels with sticks
plot + 
  geom_point(data = btn_sub, aes(y = P8MEA, x = PERCTOT), color = "black") +
  geom_smooth(data = btn_sub, aes(y = P8MEA, x = PERCTOT), method = "lm", se = FALSE, color = "black") +  # Add linear model line for btn_sub
  geom_text_repel(data = btn_sub, aes(y = P8MEA, x = PERCTOT, label = SCHNAME.x), color = "black", size = 3, nudge_y = c(-1.5, 1.5), force = 10, box.padding = 0.5, max.overlaps = 10, direction = "both")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot <- ggplot(england_school_2022_23_not_special, aes(y = PTFSM6CLA1A, x = PERCTOT, colour = OFSTEDRATING)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Add linear model line for england_school_2022_23
  labs(title = "FSM % vs Overall Absence %, 2022-23",
       x = "% FSM/Disadvantaged",
       y = "% Percentage of overall absence (authorised and unauthorised)") +
  theme_minimal()

plot
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
cor <- cor(england_school_2022_23_not_special$PTFSM6CLA1A, england_school_2022_23_not_special$PERCTOT, use = "complete.obs")

cor
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
## regression model

library(gglm)
library(car)
library(jtools)
library(kableExtra)

# Create a linear model

model <- lm(P8MEA ~ PPERSABS10 + PTFSM6CLA1A + OFSTEDRATING, data = england_school_2022_23_not_special)

vif_values <- car::vif(model)
vif_values

summ(model, scale = TRUE)

#gglm(model)

```

```{r}
plot_summs(model, inner_ci_level = .9, scale = TRUE)
```
